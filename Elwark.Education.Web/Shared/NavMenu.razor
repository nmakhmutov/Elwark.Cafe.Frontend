@using Microsoft.Extensions.Options
@using Elwark.Education.Web.Services.History
@using Elwark.Education.Web.Services.History.Model
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Elwark.Education.Web.Pages.History
@using Index = Elwark.Education.Web.Pages.History.Index
@inject UrlsOptions Options;
@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager

<MudNavMenu Class="mudblazor-navmenu">
    <AuthorizeView>
        <Authorized>
            <MudAvatar Image="@(context.User.Claims.First(x => x.Type == "picture").Value)" Size="Size.Large" Style="margin: 10px auto"/>
            <MudText Typo="Typo.h6" Align="Align.Center">@context.User.Identity?.Name</MudText>

            <MudDivider Class="my-5"/>

            <MudNavLink Icon="@Icons.Material.Person" Href="@(Options.Account.ToString())">My Account</MudNavLink>
            <MudNavLink Icon="@Icons.Material.DonutLarge" Href="profile">Profile</MudNavLink>

            <MudDivider Class="my-5"/>
        </Authorized>

        <Authorizing>
            <MudSkeleton SkeletonType="SkeletonType.Circle" Width="56px" Height="56px" Style="margin: 10px auto"/>
            <MudSkeleton SkeletonType="SkeletonType.Text" Width="90%" Style="margin: 0 auto"/>
            <MudDivider Class="my-5"/>

            <MudSkeleton SkeletonType="SkeletonType.Text" Width="90%" Style="margin: 0 auto"/>
            <MudSkeleton SkeletonType="SkeletonType.Text" Width="90%" Style="margin: 0 auto"/>
            <MudDivider Class="my-5"/>
        </Authorizing>

        <NotAuthorized>
            <a href="authentication/login">Log in</a>
        </NotAuthorized>

    </AuthorizeView>

    <MudNavGroup
        Title="History"
        Expanded="@(_subject == Subject.History)"
        Icon="@TwoTone.AccountBalanceTwoTone"
        ExpandIcon="@Filled.ExpandMore">
        <Virtualize Items="HistoryPages" Context="period">
            <MudNavLink Href="@period.Key">
                @period.Value
            </MudNavLink>
        </Virtualize>
    </MudNavGroup>

    <AuthorizeView>
        <Authorized>
            <div class="mudblazor-navmenu-spacer"></div>
            <MudButton Variant="Variant.Text" StartIcon="@(Filled.Login)" OnClick="@BeginSignOut">
                Log out
            </MudButton>
        </Authorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private Subject _subject;

    private static readonly Dictionary<string, string> HistoryPages = new()
    {
        [HistoryLinks.Period(PeriodType.Prehistory)] = "Prehistory",
        [HistoryLinks.Period(PeriodType.Ancient)] = "Ancient",
        [HistoryLinks.Period(PeriodType.MiddleAges)] = "Middle ages",
        [HistoryLinks.Period(PeriodType.EarlyModern)] = "Early modern",
        [HistoryLinks.Period(PeriodType.Modern)] = "Modern"
    };

    protected override void OnInitialized()
    {
        var path = $"/{Navigation.ToBaseRelativePath(Navigation.Uri)}";
        if (path.StartsWith(HistoryLinks.Index))
            _subject = Subject.History;
    }

    private async Task BeginSignOut(MouseEventArgs args)
    {
        await SignOutManager.SetSignOutState();
        Navigation.NavigateTo("authentication/logout");
    }

}