@using Microsoft.Extensions.Options
@using Elwark.Education.Web.Services.History
@using Elwark.Education.Web.Services.History.Model
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication
@using Elwark.Education.Web.Pages.History
@inject UrlsOptions Options;
@inject NavigationManager Navigation
@inject SignOutSessionStateManager SignOutManager

<MudNavMenu Class="navmenu">
    <AuthorizeView>
        <Authorized>
            <MudNavLink Icon="@Filled.Person" Href="@(Options.Account.ToString())">
                Elwark Account
            </MudNavLink>
            <MudNavLink Icon="@Filled.DonutLarge" Href="profile">
                Profile
            </MudNavLink>
            <MudDivider DividerType="DividerType.Middle" Class="ma-3"/>
        </Authorized>
    </AuthorizeView>
    
    <MudNavGroup
        Title="History"
        Expanded="@(_subject == Subject.History)"
        Icon="@TwoTone.AccountBalanceTwoTone"
        ExpandIcon="@Filled.ExpandMore">
        <Virtualize Items="HistoryPages" Context="period">
            <MudNavLink Href="@period.Key">
                @period.Value
            </MudNavLink>
        </Virtualize>
    </MudNavGroup>

    <AuthorizeView>
        <Authorized>
            <MudAppBarSpacer/>
            <MudButton Variant="Variant.Text" StartIcon="@(Filled.Login)" OnClick="@BeginSignOut">
                Log out
            </MudButton>
        </Authorized>
    </AuthorizeView>
</MudNavMenu>

@code {
    private Subject _subject;

    private static readonly Dictionary<string, string> HistoryPages = new()
    {
        [HistoryLinks.Period(PeriodType.Prehistory)] = "Prehistory",
        [HistoryLinks.Period(PeriodType.Ancient)] = "Ancient",
        [HistoryLinks.Period(PeriodType.MiddleAges)] = "Middle ages",
        [HistoryLinks.Period(PeriodType.EarlyModern)] = "Early modern",
        [HistoryLinks.Period(PeriodType.Modern)] = "Modern"
    };

    protected override void OnInitialized()
    {
        var path = $"/{Navigation.ToBaseRelativePath(Navigation.Uri)}";
        if (path.StartsWith(HistoryLinks.Index))
            _subject = Subject.History;
    }

    private async Task BeginSignOut(MouseEventArgs args)
    {
        await SignOutManager.SetSignOutState();
        Navigation.NavigateTo("authentication/logout");
    }

}