@page "/profile/{page}/tests/{id}"
@using Elwark.Education.Web.Gateways.History
@using Elwark.Education.Web.Gateways.Models.TestConclusion
@layout ProfileLayout

@inject IHistoryClient HistoryClient
@inject IStringLocalizer<App> L

@attribute [Authorize]

<ProfileSubjectHeader SubjectType="@SubjectType.History"/>
<ApiResponseViewer InitLoader="@Loader">
    <Loading>
        <CardsSkeleton Count="1"/>
    </Loading>
    <Result Context="data">
        <ProfileTestDetail Class="my-6" Conclusion="@data" ContentLink="@ContentLink(data)"/>
    </Result>
</ApiResponseViewer>

@code {

    [Parameter]
    public string Page { get; set; } = string.Empty;

    [Parameter]
    public string Id { get; set; } = string.Empty;

    private SubjectType _subjectType;

    protected override void OnParametersSet() =>
        Enum.TryParse(Page, true, out _subjectType);

    private Task<ApiResponse<TestConclusionDetail>> Loader() =>
        _subjectType switch{
            SubjectType.History => HistoryClient.GetMyTestConclusionAsync(Id),
            _ => Task.FromResult(ApiResponse<TestConclusionDetail>.Fail(Error.NotFound))
            };

    private string ContentLink(TestConclusionDetail detail) =>
        detail switch {
            ArticleTestConclusionDetail x => Links.Subjects.Article(_subjectType, x.ArticleId),
            TopicTestConclusionDetail x => Links.Subjects.Topic(_subjectType, x.TopicId),
            _ => string.Empty
            };

}