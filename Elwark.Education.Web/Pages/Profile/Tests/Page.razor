@page "/profile/{subject}/tests"
@using Elwark.Education.Web.Gateways.History
@using Elwark.Education.Web.Gateways.Models.TestConclusion
@using Elwark.Education.Web.Pages.Profile.Components

@inject IHistoryClient HistoryClient
@inject IStringLocalizer<App> L

@attribute [Authorize]

<ProfileSubjectHeader SubjectType="@_subject" Selected="@(ProfileSubMenu.Tests)"/>
<div class="grid ma-6">
    <ApiResponsePageableViewer
        InitLoader="@(() => LoaderAsync(new PageableRequest(null, 20)))"
        AppendLoader="@(token => LoaderAsync(new PageableRequest(token, 20)))">
        <Loading>
            <SkeletonCard/>
        </Loading>
        <Result Context="items">
            <Title Value="@L["CompletedTests"]"></Title>
            @{
                var date = DateTime.MinValue;
            }
            @foreach (var item in items)
            {
                if (date.Date != item.CreatedAt.Date)
                {
                    date = item.CreatedAt;
                    <div class="date-divider">
                        <div class="divider-text">
                            <MudText Typo="Typo.h4">
                                @item.CreatedAt.ToShortDateString()
                            </MudText>
                            <div class="divider-line"></div>
                        </div>
                    </div>
                }
                <MudCard>
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudLink Href="@Links.Profile.TestDetail(_subject, item.TestId)" Typo="Typo.h6">
                                @if (item.Title is null)
                                {
                                    <em>
                                        @L["Deleted"]
                                    </em>
                                }
                                else
                                {
                                    @item.Title
                                }
                            </MudLink>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <TestConclusionItem
                            Status="@item.Status"
                            CompletedAt="@item.CreatedAt"
                            TimeSpent="@item.TimeSpent"
                            TotalScore="@item.UserScore.Total"
                            Details="@Links.Profile.TestDetail(_subject, item.TestId)"/>
                    </MudCardContent>
                </MudCard>
            }
        </Result>
    </ApiResponsePageableViewer>
</div>

@code
{
    private SubjectType _subject;

    [Parameter]
    public string Subject { get; set; } = string.Empty;

    protected override void OnInitialized() =>
        Enum.TryParse(Subject, true, out _subject);

    private Task<ApiResponse<PageableResponse<TestConclusionSummary>>> LoaderAsync(PageableRequest request) =>
        _subject switch{
            SubjectType.History => HistoryClient.GetMyTestConclusionsAsync(request),
            _ => Task.FromResult(ApiResponse<PageableResponse<TestConclusionSummary>>.Fail(Error.NotFound))
            };

}
