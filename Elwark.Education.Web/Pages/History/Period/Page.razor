@page "/history/{type}"
@using Elwark.Education.Web.Gateways.History
@using Elwark.Education.Web.Gateways.History.Request
@using Elwark.Education.Web.Gateways.Models.History
@inject IHistoryClient HistoryClient
@inject IStringLocalizer<App> L

@attribute [Authorize]

<div class="layout">
    <ApiResponseViewer Response="_period">
        <Loading>
            <div class="header">
                <SkeletonCard Class="h-100" ImgHeight="70%"/>
            </div>
        </Loading>
        <Result Context="period">
            <Title Value="@(period.Title)"/>

            <div class="header">
                <div class="image mb-6">
                    <img src="@period.Image" loading="lazy" alt="@period.Title"/>
                </div>
                <MudText Class="title" Typo="Typo.h1">
                    @period.Title
                </MudText>
                <MudLink Class="period-link" Href="@(Links.History.Index)">
                    @L["Subject:History"]
                </MudLink>
                <MudText Typo="Typo.subtitle1" Class="mt-6">
                    @period.Description
                </MudText>
            </div>
        </Result>
    </ApiResponseViewer>

    <ApiResponseViewer Response="_topics">
        <Loading>
            <SkeletonCard/>
            <SkeletonCard/>
            <SkeletonCard/>
            <SkeletonCard/>
        </Loading>
        <Result Context="topics">
            @foreach (var item in topics.Items)
            {
                <TopicCard
                    Id="@item.Id"
                    Href="@Links.History.Topics(item.Id)"
                    Image="@item.Image"
                    Title="@item.Title"
                    Subtitle="@item.Overview"
                    Rating="@item.Rating"
                    IsFavorite="@item.IsFavorite"
                    OnFavoriteClick="@OnFavoriteClick">
                    <ImageFooter>
                        <HistoryPeriodChip Class="ma-0" Period="@item.Period"/>
                    </ImageFooter>
                </TopicCard>
            }
            <InfinityScroll ObserverTargetId="observerTarget" ObservableTargetReached="@LoadMoreAsync">
                <div id="observerTarget" class="full-row d-flex justify-center my-6">
                    @if (_request.Token is not null)
                    {
                        <MudProgressCircular Indeterminate="true"/>
                    }
                </div>
            </InfinityScroll>
        </Result>
    </ApiResponseViewer>
</div>

@code {
    private ApiResponse<HistoryPeriodModel> _period = ApiResponse<HistoryPeriodModel>.Loading();

    private ApiResponse<PageResponse<TopicSummary>> _topics = ApiResponse<PageResponse<TopicSummary>>.Loading();

    private GetTopicsRequest _request = new(HistoryPeriodType.Prehistory, null, 20);

    [Parameter]
    public string? Type { get; set; }

    protected override async Task OnParametersSetAsync()
    {
        _period = ApiResponse<HistoryPeriodModel>.Loading();
        _topics = ApiResponse<PageResponse<TopicSummary>>.Loading();

        if (Enum.TryParse<HistoryPeriodType>(Type, true, out var type))
        {
            _request = new GetTopicsRequest(type, null, 20);

            _period = await HistoryClient.GetPeriodAsync(type);
            _topics = await HistoryClient.Topic.GetAsync(_request);

            _request = _request with {Token = _topics.Data.Token};
        }
        else
        {
            _period = ApiResponse<HistoryPeriodModel>.Fail(Error.NotFound);
        }
    }

    private async Task LoadMoreAsync()
    {
        if (_request.Token is null)
            return;

        var result = await HistoryClient.Topic.GetAsync(_request);

        if (result.Status == ResponseStatus.Fail)
        {
            _topics = ApiResponse<PageResponse<TopicSummary>>.Fail(result.Error);
            return;
        }

        _topics = ApiResponse<PageResponse<TopicSummary>>.Success(
            new PageResponse<TopicSummary>(
                _topics.Data.Items.Union(result.Data.Items).ToArray(),
                result.Data.Token
                )
            );

        _request = _request with {Token = result.Data.Token};
    }

    private async Task<bool> OnFavoriteClick(string topicId)
    {
        var result = await HistoryClient.Topic.ToggleFavoriteAsync(topicId);
        return result.Status == ResponseStatus.Success && result.Data;
    }

}
