@page "/history/topic/{id}"
@using Elwark.Education.Web.Services.History.Model
@using Elwark.Education.Web.Services
@inject IHistoryService HistoryService
@attribute [Authorize]

@if (_topic is null)
{
    <PageLoader/>
}
else
{
    <Title Value="@_topic.Title"/>
    <div class="container">
        <div class="image-container">
            <div class="image" style="background-image: url(@_topic.Image)">
                <div class="cover">
                    <div class="title-container">
                        <MudText Typo="Typo.h4" Class="mb-3">@_topic.Title</MudText>
                        <MudText Typo="Typo.subtitle1">@_topic.Date</MudText>
                    </div>
                </div>
            </div>
        </div>
        <div class="articles-container">
            <Breadcrumbs Items="@_breadcrumbsItems" Class="ma-6"/>
            <MudText Typo="Typo.body1" Class="ma-6" Style="max-width: 980px">
                @_topic.Description
            </MudText>
            <Virtualize Items="@_topic.Articles" Context="item">
                <div class="article-card mud-paper ma-6 pa-3">
                    <div class="article-image">
                        @if (item.Image is not null)
                        {
                            <MudAvatar Image="@(item.Image)" Square="true" Style="width: 90px; height: 90px"/>                            
                        }
                    </div>
                    <div class="article-texts">
                        @if (item.Type == ArticleType.Premium)
                        {
                            <MudText Typo="Typo.body2" Color="Color.Warning">@item.Type</MudText>                        }
                        <MudLink Typo="Typo.h5" Href="@($"/history/article/{item.ArticleId}")">
                            @item.Title
                        </MudLink>
                        @if (item.Test.PassedAt.HasValue)
                        {
                            <MudText Typo="Typo.body2">
                                <em>Last passed at @item.Test.PassedAt.Value.ToShortDateString()</em>
                            </MudText>                        }
                    </div>
                    <div class="article-description">
                        <MudText Typo="Typo.body1">@item.Subtitle</MudText>
                    </div>
                </div>
            </Virtualize>
        </div>
    </div>
}

@code {
    private HistoryTopicModel? _topic;

    private BreadcrumbsItem[] _breadcrumbsItems = Array.Empty<BreadcrumbsItem>();

    [Parameter]
    public string Id { get; set; } = string.Empty;

    protected override async Task OnParametersSetAsync()
    {
        _topic = await HistoryService.GetTopicAsync(Id);
        if (_topic is not null)
            _breadcrumbsItems = new BreadcrumbsItem[]
            {
                new("History", "/history"),
                new(_topic.Period.Title, $"/history/{_topic.Period.Type}")
            };
    }

}